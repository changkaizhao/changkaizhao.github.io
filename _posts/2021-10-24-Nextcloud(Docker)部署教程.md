---
layout: post
title: Nextcloud(Docker)éƒ¨ç½²æ•™ç¨‹
tags: æ ‘è“æ´¾4 nextcloud docker
---

> ä½œè€…ï¼šRoby
# Nextcloud(Docker)éƒ¨ç½²æ•™ç¨‹

## ä¸€ã€ä»‹ç»

è¿™ä¸ªæ•™ç¨‹ä¸»è¦ä»‹ç»å¦‚ä½•é€šè¿‡**æ ‘è“æ´¾4**+**ubuntu**æ¥é…ç½®**NextCloud**ç§æœ‰äº‘æœåŠ¡ã€‚

### éœ€è¦å…·å¤‡çš„çŸ¥è¯†ï¼š

* Linuxçš„ç®€å•å‘½ä»¤è¡Œæ“ä½œ
* ç½‘ç»œå’ŒæœåŠ¡å™¨çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ

### éœ€è¦å…·å¤‡çš„ç¡¬ä»¶ï¼š

* ä¸€å°å·²ç»è¿å…¥æœ¬åœ°**LAN**çš„**æ ‘è“æ´¾4**æœºå™¨ï¼Œå¹¶ä¸”å·²ç»å®‰è£…å¥½**Ubuntu**(æœ¬æ•™ç¨‹ä½¿ç”¨çš„ç³»ç»Ÿï¼Œå…¶ä»–ç³»ç»Ÿä¾‹å¦‚**Raspberry Pi OS** ä¹Ÿå¯ä»¥)
* ä¸€å°**è·¯ç”±å™¨**ï¼Œå¯ä»¥å…·å¤‡è®¾ç½®DDNSï¼Œè·¯ç”±è½¬å‘æˆ–è€…DMZåŠŸèƒ½ã€‚
* æœ€å¥½ç»™**æ ‘è“æ´¾**å¤–æ¥ä¸€ä¸ªå¤§å®¹é‡ç¡¬ç›˜ï¼ˆæœ¬æ•™ç¨‹ä½¿ç”¨ä¸€ä¸ª4Tçš„è¥¿æ•°ç¡¬ç›˜ï¼‰

## äºŒã€é…ç½®è·¯ç”±å™¨

### åŠ¨æ€ç»‘å®šåŸŸå

ç”±äºå®¶åº­ç”¨ç½‘ç»œçš„IPåœ°å€å¹¶ä¸æ˜¯é™æ€IPï¼ŒIPæ”¹å˜åç”¨æˆ·å°±æ— æ³•é€šè¿‡å¤–ç½‘è®¿é—®å†…ç½‘æœåŠ¡ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡**åŠ¨æ€åŸŸåè§£æ**(**DDNS**)è§£å†³ã€‚ è¦è®¾ç½®**DDNS**å°±éœ€è¦æœ‰ä¸€ä¸ªåŸŸåã€‚

å¯ä»¥åœ¨[èŠ±ç”Ÿå£³](https://hsk.oray.com/)ç”³è¯·ä¸€ä¸ªå…è´¹çš„äºŒçº§åŸŸåã€‚æ³¨å†Œåç›´æ¥è¿›å…¥æ§åˆ¶å°å°±å¯ä»¥çœ‹åˆ°äº†ã€‚

åŸŸåå¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š`**********.qicp.vip`

æœ‰äº†åŸŸååæˆ‘ä»¬å°±è¦åŠ¨æ€çš„ç»‘å®šåˆ°æˆ‘ä»¬çš„IPã€‚ä»¥æˆ‘ä½¿ç”¨çš„**å°ç±³è·¯ç”±4Aåƒå…†ç‰ˆ**ä¸ºä¾‹ï¼Œè¿›å…¥è·¯ç”±ç®¡ç†ç•Œ(`miwifi.com`)é¢åæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

> ç‚¹å‡»**é«˜çº§è®¾ç½®**\
> ç‚¹å‡»**DDNS**\
> ç‚¹å‡»æ·»åŠ æœåŠ¡æŒ‰é’®\
> é€‰æ‹©DNSæœåŠ¡å•†æœ¬æ•™ç¨‹æ˜¯èŠ±ç”Ÿå£³ï¼Œç”¨æˆ·åå’Œå¯†ç ä¸ºèŠ±ç”Ÿå£³çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œä¸»æœºåå¡«å†™ç”³è¯·åˆ°çš„äºŒçº§åŸŸå,æ£€æŸ¥æ—¶é—´å’Œå¼ºåˆ¶æ›´æ–°æ—¶é—´å¯ä»¥ä»»æ„è®¾ç½®æœ¬æ•™ç¨‹å¡«å†™10åˆ†é’Ÿå’Œ1å°æ—¶ã€‚ ç‚¹å‡»ç¡®å®š

ç°åœ¨å®¶åº­çš„**IP**åœ°å€å·²ç»åŠ¨æ€çš„ç»‘å®šåˆ°åŸŸåä¸Šï¼Œä¸€æ—¦**IP**æœ‰å˜åŒ–ï¼Œè·¯ç”±å™¨ä¼šé€šçŸ¥DNSæœåŠ¡å™¨æ”¹å˜åŸŸåç»‘å®šçš„**IP**ï¼Œè¿™æ ·å°±ä¿è¯å¤–ç½‘å¯ä»¥é€šè¿‡åŸŸåæ¥è®¿é—®å†…ç½‘äº†ã€‚

### è®¾ç½®è·¯ç”±è½¬å‘æˆ–è€…DMZ

å¦‚æœè·¯ç”±å™¨æœ‰**DMZ**åŠŸèƒ½å»ºè®®æ‰“å¼€**DMZ**ï¼Œç›´æ¥å°†**DMZ**çš„**IP**è®¾ä¸ºæ ‘è“æ´¾çš„**æœ¬åœ° IP**ï¼Œè¿™æ ·å¤–ç½‘è¿›æ¥çš„è¯·æ±‚å…¨éƒ¨è½¬å‘ç»™æ ‘è“æ´¾å»å¤„ç†ï¼Œæœ¬æ•™ç¨‹ä½¿ç”¨**DMZ**çš„æ–¹å¼ã€‚ å…¶ä»–æ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘æ–¹å¼å°†å¤–éƒ¨ç«¯å£æ˜ å°„åˆ°æ ‘è“æ´¾çš„æœ¬åœ°ç«¯å£ï¼Œæœ‰äº›è·¯ç”±å™¨çš„é˜²ç«å¢™ä¼šå°†æ‰€æœ‰ç«¯å£çš„å¤–ç½‘è®¿é—®ç¦æ­¢ï¼Œå°±éœ€è¦ROOTè·¯ç”±å™¨æ‰“å¼€ç«¯å£ï¼Œé‡åˆ°è¿™ç§æƒ…å†µæ¯”è¾ƒæŠ˜è…¾ï¼Œæœ¬æ•™ç¨‹å°±ä¸è®¨è®ºäº†ã€‚

åŒæ ·æ–¹å¼è¿›å…¥è·¯ç”±ç®¡ç†ç•Œé¢åï¼Œæ‰“å¼€DMZæ–¹æ³•å¦‚ä¸‹ï¼š

> ç‚¹å‡»é«˜çº§è®¾ç½®\
> ç‚¹å‡»è·¯ç”±è½¬å‘\
> æ‰“å¼€DMZå¼€å…³\
> å°†æ ‘è“æ´¾çš„æœ¬åœ°IPæœ€åçš„**ä¸‰ä½æ•°**å¡«å…¥\
> ç‚¹å‡»åº”ç”¨

è·å–æ ‘è“æ´¾çš„**IP**æ–¹æ³•ï¼Œ`ssh`è¿›å…¥æ ‘è“æ´¾ååœ¨ç»ˆç«¯ç•Œé¢æ‰§è¡Œå¦‚ä¸‹ï¼š

```
  $ ip addr show
```

å¦‚æœé“¾æ¥çš„æœ‰çº¿ç½‘çº¿ï¼Œå¯ä»¥åœ¨`eth0`é¡¹é‡Œçœ‹åˆ°`inet`çš„å€¼,æ— çº¿è¿æ¥åœ¨`wlan0`é‡ŒæŸ¥çœ‹`inet`çš„å€¼ã€‚

âš ï¸æœ€å¥½ä¹Ÿé€šè¿‡è·¯ç”±å™¨æŠŠæ ‘è“æ´¾çš„**æœ¬åœ° IP** é™æ€åˆ†é…ï¼Œè¿™æ ·æ ‘è“æ´¾çš„æœ¬åœ°IPå°±ä¸ä¼šåœ¨è®¾é…é‡å¯åéšæ„æ”¹å˜äº†ã€‚

## ä¸‰ã€éƒ¨ç½²Nextcloud

ç»ˆäºè¿›å…¥æ­£é¢˜äº†ğŸ˜„

### 3.1 å‡†å¤‡å·¥ä½œï¼š

* æ ‘è“æ´¾ä¸Šçš„æ“ä½œç³»ç»Ÿå®‰è£…å¥½**docker**
* å°†å¤–ç½®ç¡¬ç›˜é“¾æ¥æ ‘è“æ´¾å¹¶æŒ‚è½½

#### dockerå®‰è£…å¯ä»¥å‚è€ƒ[å®˜ç½‘æ•™ç¨‹](https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository)

#### æŒ‚è½½å¤–æ¥ç¡¬ç›˜

æœ¬ä¾‹å­ä»¥è¥¿æ•°çš„HDDä¸ºä¾‹ï¼Œå°†ç¡¬ç›˜é€šè¿‡sataè½¬USBçº¿é“¾æ¥æ ‘è“æ´¾ååˆ†åˆ«æ‰§è¡Œæ ¼å¼åŒ–å’ŒæŒ‚è½½æ“ä½œã€‚

å…ˆæŸ¥è¯¢ä¸€ä¸‹å¤–æ¥çš„ç¡¬ç›˜åå­—ï¼š

```
   $ lsblk

    NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
    ...
    sda           8:0    0  3.7T  0 disk 
    mmcblk0     179:0    0 59.5G  0 disk 
    â”œâ”€mmcblk0p1 179:1    0  256M  0 part /boot/firmware
    â””â”€mmcblk0p2 179:2    0 59.2G  0 part /
```

å¯ä»¥çœ‹åˆ°æˆ‘çš„è®¾å¤‡åç§°æ˜¯`sda`.

æ ¼å¼åŒ–è®¾å¤‡æ–‡ä»¶æ ¼å¼ä¸º**ext4**ï¼š

```
  $ kfs.ext4 /dev/sda
```

å°†è®¾å¤‡æŒ‚è½½åˆ°ç³»ç»Ÿæ ¹ç›®å½•ä¸‹çš„`/mnt/data`ç›®å½•

```
  $ mount /dev/sda  /mnt/data
```

è¿™æ ·å°±å¯ä»¥é€šè¿‡æŒ‚è½½ç›®å½•`/mnt/data`å¯¹å¤–æ¥ç¡¬ç›˜å­˜å–æ•°æ®ã€‚

### 3.2 æ–°å»ºdockerç½‘ç»œ

å½“ç„¶ç”¨é»˜è®¤ç½‘ç»œä¹Ÿå¯ä»¥ã€‚

```
 $docker network create --driver bridge nextcloud-net 
```

ä¸Šé¢å‘½ä»¤æ–°å»ºäº†ä¸€ä¸ªåå­—ä¸º`nextcloud-net`çš„æ¡¥æ¥ç½‘ç»œã€‚ä¹‹åçš„æ•°æ®åº“å’ŒnextcloudæœåŠ¡éƒ½ä¼šéƒ¨ç½²åœ¨è¿™ä¸ªç½‘ç»œã€‚

### 3.3 å®‰è£…æ•°æ®åº“(postgresql)

é€šè¿‡`docker`å®‰è£…æ•°æ®åº“ï¼Œå¯ä»¥é€‰è‡ªå·±ç†Ÿæ‚‰çš„ï¼Œä¾‹å¦‚`mysql` ç­‰ã€‚è¿™é‡Œä»¥`postgresql`ä¸ºä¾‹ã€‚

æ–°å»ºä¸€ä¸ª**postgres**æ•°æ®åº“å®¹å™¨å¹¶è¿è¡Œå¯åŠ¨ï¼Œè®°ä½å¯†ç ã€‚

```
docker run --name postgres --network nextcloud-net  -v /home/usr/postgres/data:/var/lib/postgresql/data -e POSTGRES_PASSWORD=****** -d postgres
```

### 3.4 åˆ›å»ºSSLè¯ä¹¦

åœ¨å¤–ç½‘è®¿é—®æ—¶ä¸€å®šè¦é€šè¿‡åŠ å¯†çš„httpsåè®®ä¼ è¾“æ•°æ®æ‰ä¼šå®‰å…¨ï¼Œå¼€å¯httpséœ€è¦ä¸€ä¸ªè¯ä¹¦ï¼Œä¸€èˆ¬æƒ…å†µè¿™ä¸ªè¯ä¹¦é€šè¿‡ç¬¬ä¸‰æ–¹è®¤è¯å¯ä¿¡æœºæ„é¢å‘ä¸è¿‡å¤§éƒ¨åˆ†éœ€è¦ä»˜è´¹ï¼Œå…¶å®ä¹Ÿå¯ä»¥å…è´¹è‡ªå·±åšä¸€ä¸ªè¯ä¹¦ã€‚

åœ¨ç”¨æˆ·ç›®å½•åˆ›å»ºä¸€ä¸ª`ssl`æ–‡ä»¶å¤¹æ¥å­˜è¯ä¹¦

```
  $ mkdir /home/usr/ssl
```

å…ˆåˆ›å»ºä¸€ä¸ªå¯†é’¥ï¼Œ å¯ä»¥å‘½åä¸º`nextcloud.key`

```
 $ openssl genrsa -des3 -out /home/usr/ssl/nextcloud.key 2048
```

åˆ›å»ºå¯†é’¥è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦è¾“å…¥`passphrase`,å¦‚æœè¾“å…¥äº†å°±è¦é€šè¿‡ä¸‹é¢åŠæ³•å»æ‰å¯†é’¥`passphrase`

```
$ mv /home/usr/ssl/nextcloud.key /home/usr/ssl/nextcloud.key.backup
$ openssl rsa -in /home/usr/ssl/nextcloud.key.backup -out /home/usr/ssl/nextcloud.key
```

åˆ›å»ºè¯ä¹¦ï¼š

```
$ openssl req -x509-new -nodes -key /home/usr/ssl/nextcloud.key -sha256-days 1825-out /home/usr/ssl/nextcloud.pem
```

è¿™æ ·å°±æœ‰äº†è‡ªå·±ç­¾å‘çš„è¯ä¹¦`nextcloud.pem`, è¿™ä¸ªæ–‡ä»¶å¯ä»¥ä»¥åä¸‹è½½ä¸‹æ¥åˆ°è‡ªå·±çš„ç”µè„‘ï¼Œæ‰‹æœºç­‰è®¾å¤‡ï¼Œå¯¹å…¶è¿›è¡Œä¿¡ä»»æ“ä½œã€‚

### 3.5 åˆ¶ä½œDockerfile

æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å­˜æ”¾`Dockerfile`å’Œ`setssl.sh`è„šæœ¬æ–‡ä»¶ã€‚

```
  $ mkdir /home/usr/dockerfile
```

åœ¨æ–‡ä»¶é‡Œé¢åˆ›å»ºä¸€ä¸ª`setssl.sh`è„šæœ¬æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼Œæ³¨æ„é‡Œé¢çš„`SSLCertificateFile` å’Œ `SSLCertificateKeyFile`çš„æ–‡ä»¶åç§°ä¸€å®šè¦è®¾ç½®ä¸ºä¹‹å‰ç”Ÿæˆçš„`key`å’Œ`pem`æ–‡ä»¶çš„åç§°

```
# setssl.sh
# USAGE: setssl.sh <domain> <email>

echo 'SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
SSLProtocol All -SSLv2 -SSLv3
SSLHonorCipherOrder On
Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains"
Header always set X-Frame-Options DENY
Header always set X-Content-Type-Options nosniff
SSLCompression off
SSLSessionTickets Off' > /etc/apache2/conf-available/ssl-params.conf
echo "<IfModule mod_ssl.c>
        <VirtualHost _default_:443>
                ServerAdmin $2
                ServerName $1
" > /etc/apache2/sites-available/default-ssl.conf
echo '
                DocumentRoot /var/www/html

                ErrorLog ${APACHE_LOG_DIR}/error.log
                CustomLog ${APACHE_LOG_DIR}/access.log combined

                SSLEngine on

                SSLCertificateFile    /etc/ssl/nextcloud/nextcloud.pem
                SSLCertificateKeyFile /etc/ssl/nextcloud/nextcloud.key

                <FilesMatch "\.(cgi|shtml|phtml|php)$">
                                SSLOptions +StdEnvVars
                </FilesMatch>
                <Directory /usr/lib/cgi-bin>
                                SSLOptions +StdEnvVars
                </Directory>
        </VirtualHost>
</IfModule>' >> /etc/apache2/sites-available/default-ssl.conf
a2enmod ssl >/dev/null
a2ensite default-ssl >/dev/null
a2enconf ssl-params >/dev/null
```

ç¼–å†™Dockerfileå†…å®¹å¦‚ä¸‹ï¼š

```
FROM nextcloud
COPY /home/usr/dockerfile/setssl.sh /usr/local/bin/
RUN /usr/local/bin/setssl.sh *******.qicp.vip yourname@mail.com
```

è¿è¡Œ\`docker build\`\` é•œåƒ

```
$ cd /home/usr/dockerfile
$ docker build --tag nextcloud_ssl .
```

è¿™æ ·å°±æœ‰äº†åå­—ä¸º`nextcloud_ssl`çš„é•œåƒï¼Œé€šè¿‡è¿™ä¸ªé•œåƒåˆ›å»ºå®¹å™¨å¹¶è¿è¡Œã€‚

```
docker run --name nextcloud -d -p 443:443 -v /mnt/data:/data -v /home/usr/nextcloud:/var/www/html -v /home/usr/ssl:/etc/ssl/nextcloud --network nextcloud-net   nextcloud_ssl
```

å¯åŠ¨åï¼Œå°±å¯ä»¥åœ¨æµè§ˆå™¨è¾“å…¥ä½ çš„åŸŸå`https://*********.qicp.vip` æ¥è®¿é—®ä½ çš„`nextcloud`æœåŠ¡ã€‚

### 3.6 é…ç½®nextcloudå¼€å§‹é¡µé¢

çœ‹åˆ°å¼€å§‹æ¬¢è¿é¡µé¢åå°±å¯ä»¥è®¾ç½®äº†ã€‚

è¾“å…¥ä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç ã€‚æœ€å¥½è®¾ç½®çš„å¼ºä¸€ç‚¹å¯†ç ï¼Œæ¯•ç«Ÿä½ çš„æ•°æ®å¾ˆå®è´µğŸ˜„ã€‚ åœ¨é…ç½®æ•°æ®åº“çš„é€‰é¡¹å¡é€‰åœ¨`postgres`é€‰é¡¹å¡ï¼Œæ ¹æ®ä½ è‡ªå·±çš„æ•°æ®åº“æœåŠ¡é€‰æ‹©ã€‚

> æ•°æ®åº“ç”¨æˆ·åå¡«å†™ `postgres`   
>
> å¯†ç  å¡«å†™ä¹‹å‰è¿è¡Œæ•°æ®åº“å®¹å™¨æ—¶è®¾ç½®çš„å¯†ç  
>
> æ•°æ®åº“åç§°å¡«å†™ `postgres` 
>
> localhost å¡«å†™ `postgres`

ç‚¹å‡»**ä¸‹ä¸€æ­¥**ç»§ç»­å°±å¥½äº†ã€‚

è¿›å…¥é¡µé¢åç‚¹å‡»å¤´åƒ->ç‚¹å‡»åº”ç”¨->ç‚¹å‡»å·²ç¦ç”¨çš„åº”ç”¨->å°†**External storage support**å¯ç”¨->ç‚¹å‡»å¤´åƒ-> ç‚¹å‡»è®¾ç½®-> ç‚¹å‡»å·¦ä¾§èœå•æ çš„å¤–éƒ¨å­˜å‚¨-> åœ¨ä¸€ä¸ªç¼–è¾‘è¡Œä¸­çš„**å¤–éƒ¨å­˜å‚¨**é€‰æ‹©åˆ—è¡¨é€‰æ‹© **æœ¬åœ°** -> **ç›®å½•åç§°**éšä¾¿èµ·ä¸ªåå­—ä¾‹å¦‚*drive* ->**é…ç½®**è¾“å…¥`/data`->ç‚¹å‡»æœ€å³ä¾§**å¯¹å·**æ·»åŠ ã€‚ è¿™æ ·åœ¨æ–‡ä»¶åº”ç”¨ä¸­å°±å¯ä»¥çœ‹åˆ°åå­—å«**drive**çš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹å†…çš„æ•°æ®éƒ½ä¼šå­˜å‚¨åˆ°å¤–æ¥çš„ç¡¬ç›˜é‡Œã€‚

ğŸ‰**æ­å–œä½ ç»ˆäºå¯ä»¥çœ‹åˆ°æœ€åçš„ç”»é¢äº†**ã€‚

æœ€åä½ å¯ä»¥åœ¨æ‰‹æœºå®‰è£…**Nextcloud App** æ“ä½œæ–‡ä»¶ã€‚è¿˜å¯ä»¥åœ¨ç”µè„‘ç«¯ä¸‹è½½ [nextcloud sync client](https://nextcloud.com/install/#install-clients)åŒæ­¥ç¨‹åºå°†ç”µè„‘çš„æ–‡ä»¶å¤¹å’Œ`nextcloud`çš„æ–‡ä»¶å¤¹è¿›è¡ŒåŒæ­¥ã€‚

**Nextcloud**æœ‰å¤§é‡æ’ä»¶åº”ç”¨å¯ä»¥ä½¿ç”¨ï¼Œæ„Ÿå…´è¶£å¯ä»¥æ…¢æ…¢æ¢ç´¢ã€‚
